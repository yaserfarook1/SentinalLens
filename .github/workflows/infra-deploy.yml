name: Infrastructure Deploy

on:
  push:
    branches: [main]
    paths:
      - 'infra/**'
      - '.github/workflows/infra-deploy.yml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

jobs:
  validate:
    name: Validate Bicep
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Azure CLI
        uses: azure/setup-cli@v1

      - name: Validate Bicep templates
        run: |
          az bicep build-params --file infra/main.bicep
          az deployment group validate \
            --resource-group sentinellens-rg \
            --template-file infra/main.bicep \
            --parameters @infra/params.dev.json

  plan:
    name: Plan Deployment
    runs-on: ubuntu-latest
    needs: [validate]
    outputs:
      deployment-changes: ${{ steps.plan.outputs.changes }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Azure CLI
        uses: azure/setup-cli@v1

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Plan Bicep deployment
        id: plan
        run: |
          az deployment group what-if \
            --resource-group sentinellens-rg \
            --template-file infra/main.bicep \
            --parameters @infra/params.dev.json > deployment-plan.txt

          echo "changes<<EOF" >> $GITHUB_OUTPUT
          cat deployment-plan.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment on PR with plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## Infrastructure Changes\n```\n${{ steps.plan.outputs.changes }}\n```'
            })

  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: [validate, plan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
    steps:
      - uses: actions/checkout@v4

      - name: Set up Azure CLI
        uses: azure/setup-cli@v1

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Bicep template
        run: |
          az deployment group create \
            --resource-group sentinellens-rg \
            --template-file infra/main.bicep \
            --parameters @infra/params.dev.json \
            --no-wait

      - name: Check deployment status
        run: |
          az deployment group show \
            --resource-group sentinellens-rg \
            --name main

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    steps:
      - name: Deployment summary
        run: |
          echo "Infrastructure deployment ${{ job.status }}"
          echo "Check Azure Portal for deployment details"
